<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ØªØ±ÙŠÙ†Ø¯Ø§Øª - Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  <script type="module" src="firebase.js"></script>
  <style>
    :root{--main:#2cbfb5;--dark:#063d28;--danger:#e74c3c;--success:#27ae60}
    body{font-family:'Cairo',sans-serif;background:#f4f6f9;margin:0}
    .container{max-width:1100px;margin:auto;padding:20px}
    .header{background:linear-gradient(135deg,var(--main),var(--dark));color:white;padding:20px;text-align:center;border-radius:0 0 20px 20px}
    .login-box{background:white;padding:30px;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,0.1);max-width:400px;margin:50px auto;text-align:center}
    input,button{width:100%;padding:15px;margin:10px 0;border-radius:12px;font-size:16px}
    input{border:1px solid #ddd}
    button{background:var(--main);color:white;border:none;cursor:pointer;font-weight:700}
    button:hover{background:var(--dark)}
    table{width:100%;border-collapse:collapse;margin:20px 0;background:white;border-radius:12px;overflow:hidden;box-shadow:0 8px 25px rgba(0,0,0,0.1)}
    th{background:var(--main);color:white;padding:15px}
    td{padding:12px;text-align:center}
    .btn-small{padding:8px 15px;font-size:14px;margin:0 5px;border-radius:8px}
    .success{background:var(--success)}
    .danger{background:var(--danger)}
    #debt{display:block;margin:20px auto;padding:15px;background:var(--danger);color:white;border-radius:12px;font-size:20px;font-weight:900}
  </style>
</head>
<body>

<div class="header">
  <h1>ØªØ±ÙŠÙ†Ø¯Ø§Øª - Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</h1>
</div>

<div class="container">
  <div id="login" class="login-box">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</h2>
    <input type="text" id="driverId" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨">
    <input type="password" id="driverPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
    <button onclick="loginDriver()">Ø¯Ø®ÙˆÙ„</button>
  </div>

  <div id="panel" style="display:none">
    <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ <span id="driverName"></span> ğŸ‘‹</h2>
    <div id="debt">Ø§Ù„Ø¯ÙŠÙ† Ø¹Ù„ÙŠÙƒ: 0 Ù„.Ø³</div>
    <h2>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</h2>
    <div id="ordersList"></div>
  </div>
</div>

<script type="module">
  import { db, collection, onSnapshot, doc, updateDoc } from "./firebase.js";

  let currentDriver = null;

  window.loginDriver = async () => {
    const id = document.getElementById("driverId").value;
    const pass = document.getElementById("driverPass").value;

    const snap = await getDoc(doc(db, "drivers", id));
    if (snap.exists() && snap.data().password === pass) {
      currentDriver = {id, ...snap.data()};
      document.getElementById("login").style.display = "none";
      document.getElementById("panel").style.display = "block";
      document.getElementById("driverName").textContent = currentDriver.name;
      loadOrders();
    } else {
      alert("Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙ„Ø·");
    }
  };

  function loadOrders() {
    onSnapshot(collection(db, "orders"), (snap) => {
      let html = "";
      let totalDebt = 0;
      snap.forEach(d => {
        const o = d.data();
        if (o.status === "Ø¬Ø¯ÙŠØ¯" || (o.status === "ÙÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„" && o.driverId === currentDriver.id)) {
          if (o.payment === "Ù†Ù‚Ø¯ÙŠ" && o.status === "ÙÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„" && o.driverId === currentDriver.id) {
            totalDebt += o.total + o.shipping;
          }
          html += `<table><tr>
            <td>#${d.id.slice(0,6)}</td>
            <td>${o.customerName}<br>${o.phone}</td>
            <td>${o.address}</td>
            <td>${o.total + o.shipping} Ù„.Ø³</td>
            <td>${o.payment}</td>
            <td>
              ${o.status === "Ø¬Ø¯ÙŠØ¯" ? `<button class="btn-small success" onclick="acceptOrder('${d.id}')">Ù‚Ø¨ÙˆÙ„</button>` : ""}
              ${o.status === "ÙÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„" && o.driverId === currentDriver.id ? `<button class="btn-small success" onclick="deliverOrder('${d.id}')">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>` : o.status}
            </td>
          </tr></table>`;
        }
      });
      document.getElementById("ordersList").innerHTML = html || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹";
      document.getElementById("debt").textContent = `Ø§Ù„Ø¯ÙŠÙ† Ø¹Ù„ÙŠÙƒ: ${totalDebt.toLocaleString()} Ù„.Ø³`;
    });
  }

  window.acceptOrder = async (id) => {
    await updateDoc(doc(db, "orders", id), {status: "ÙÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„", driverId: currentDriver.id, driverName: currentDriver.name, acceptedAt: Date.now()});
  };

  window.deliverOrder = async (id) => {
    if(confirm("ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ ÙØ¹Ù„Ø§Ù‹ØŸ")) {
      await updateDoc(doc(db, "orders", id), {status: "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…", deliveredAt: Date.now()});
    }
  };
</script>
</body>
</html>